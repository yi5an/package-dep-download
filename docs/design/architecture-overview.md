# 离线软件包下载服务 - 系统架构

## 整体架构

采用经典的三层架构:

```
┌─────────────────────────────────────────────────────────┐
│                     浏览器端 (前端)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐  │
│  │ 主页面   │  │ 包搜索   │  │ 任务列表 │  │ 设置   │  │
│  └──────────┘  └──────────┘  └──────────┘  └────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↕ HTTP/SSE
┌─────────────────────────────────────────────────────────┐
│                  FastAPI 服务器 (后端)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  REST API    │  │ WebSocket/SSE│  │  任务管理器   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │         包下载器 (调用 offline-installer.sh)      │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────┐
│                     文件系统                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │downloads/│  │ tasks.db │  │ logs/    │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 前端 (原生 JavaScript)
- **单页应用 (SPA)**: 所有交互在一个页面完成
- **Server-Sent Events (SSE)**: 接收实时下载进度
- **模块化设计**: 分离 UI、API、工具函数
- **响应式布局**: 支持桌面和移动端

### 2. 后端 (FastAPI)
- **REST API**: 处理 HTTP 请求
- **SSE 端点**: 推送实时进度
- **后台任务**: 异步执行下载
- **任务队列**: 管理并发下载
- **文件管理**: 自动清理过期文件

### 3. 包下载器
- **调用现有脚本**: 使用 `offline-installer.sh`
- **进度解析**: 解析脚本输出,提取进度信息
- **错误处理**: 捕获并返回错误信息

## 数据流

### 下载流程

```
用户输入包名
    ↓
前端验证并发送 POST /api/download
    ↓
后端创建任务,返回 task_id
    ↓
后台线程启动下载进程
    ↓
SSE 实时推送进度
    ↓
下载完成后打包成 tar.gz
    ↓
前端自动触发下载
```

### 实时通信

```
前端 → POST /api/download → 后端创建任务
前端 ← 返回 task_id ← 后端
前端 → GET /api/events/{task_id} → 建立 SSE 连接
后端 → 推送进度更新 → 前端更新 UI
后端 → 推送完成消息 → 前端触发下载
```

## 技术栈确定

**后端**:
- FastAPI 0.100+ (异步、高性能、自动文档)
- uvicorn (ASGI 服务器)
- asyncio (异步任务管理)

**前端**:
- 原生 JavaScript ES6+
- CSS3 (Flexbox/Grid)
- Server-Sent Events API

**工具**:
- 复用现有的 `offline-installer.sh`
- Python 标准库 (subprocess, threading, pathlib)

**部署**:
- 单文件启动: `python backend/app.py`
- 或 Docker 容器
